# Will include other oses once sdl3_mixer is available on vcpkg. sdl3_mixer just released their first prerelease on Jan 21, 2026 so it should be soon.

name: Windows & Android Build (Push/PR)

on: [push, pull_request]

env:
    PROJECT_NAME: Connect4
    VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
    build:
        name: ${{ matrix.name }}
        runs-on: ${{ matrix.os }}

        strategy:
            fail-fast: false
            matrix:
                include:
                    - name: Windows-MSVC
                      preset: windows-msvc
                      build_preset: msvc-release
                      os: windows-2022
                    - name: Android
                      preset: android
                      os: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  submodules: true
                  fetch-depth: 0

            # Export GitHub Actions cache for vcpkg
            - name: Export GitHub Actions cache environment variables
              uses: actions/github-script@v7
              with:
                  script: |
                      core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
                      core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

            # --- ANDROID SETUP ---
            - name: Setup Java
              if: matrix.preset == 'android'
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"

            # --- CONFIGURE & BUILD (Windows) ---
            - name: Setup CMake (Non-Android Only)
              if: matrix.preset != 'android'
              uses: jwlawson/actions-setup-cmake@v2
              with:
                  cmake-version: "3.31.x"

            - name: Configure CMake
              if: matrix.preset != 'android'
              run: cmake --preset ${{ matrix.preset }} -DCMAKE_BUILD_TYPE=Release

            - name: Build
              if: matrix.preset != 'android'
              run: cmake --build --preset msvc-release

            # --- BUILD (Android) ---
            - name: Decode Keystore
              if: matrix.preset == 'android'
              env:
                  ANDROID_DEBUG_KEYSTORE_BASE64: ${{ secrets.ANDROID_DEBUG_KEYSTORE_BASE64 }}
              run: |
                  cd android/app
                  if [ -n "$ANDROID_DEBUG_KEYSTORE_BASE64" ]; then
                    echo "Decoding custom debug keystore..."
                    echo "$ANDROID_DEBUG_KEYSTORE_BASE64" | base64 --decode > debug.keystore
                  else
                    echo "Secret is empty (likely a fork). Using default Android debug keystore."
                  fi

            - name: Build Android APK
              if: matrix.preset == 'android'
              run: |
                  cd android
                  chmod +x gradlew
                  ./gradlew assembleDebug --no-daemon

            # --- ARTIFACT PREPARATION ---
            - name: Prepare Artifacts
              shell: bash
              run: |
                  mkdir -p staging

                  # --- WINDOWS: Collect EXE + DLLs ---
                  if [[ "${{ runner.os }}" == "Windows" ]]; then
                    find build -name "${PROJECT_NAME}.exe" -exec cp {} staging/ \;
                    find build -name "*.dll" -exec cp {} staging/ \;
                    find build -name "${PROJECT_NAME}.dat" -exec cp {} staging/ \;
                  fi

                  # --- ANDROID: Collect APK ---
                  if [[ "${{ matrix.preset }}" == "android" ]]; then
                    find android -name "*.apk" -exec cp {} staging/ \;
                  fi

            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.PROJECT_NAME }}-${{ matrix.name }}
                  path: staging/*
