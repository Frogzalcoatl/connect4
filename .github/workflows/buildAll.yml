name: Build All

on: [workflow_dispatch]

env:
    PROJECT_NAME: Connect4
    VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
    build:
        name: ${{ matrix.name }}
        runs-on: ${{ matrix.os }}

        strategy:
            fail-fast: false
            matrix:
                include:
                    - name: Windows-MSVC
                      preset: windows-msvc
                      build_preset: msvc-release
                      os: windows-2022
                    - name: Linux-GCC
                      preset: linux-gcc
                      build_preset: linux-gcc-release
                      os: ubuntu-latest
                    - name: MacOS-Clang
                      preset: macos-clang
                      build_preset: macos-clang-release
                      os: macos-latest
                    - name: Android
                      preset: android
                      os: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  submodules: true
                  fetch-depth: 0

            # Export GitHub Actions cache for vcpkg
            - name: Export GitHub Actions cache environment variables
              uses: actions/github-script@v7
              with:
                  script: |
                      core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
                      core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

            # --- SYSTEM DEPENDENCIES (Required for SDL/vcpkg to build on Linux) ---
            - name: Install Linux Dependencies
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    build-essential cmake ninja-build pkg-config \
                    libasound2-dev libpulse-dev libx11-dev libxext-dev \
                    libxrandr-dev libxcursor-dev libxfixes-dev libxi-dev \
                    libxss-dev libxtst-dev libxkbcommon-dev libdrm-dev \
                    libgbm-dev libgl1-mesa-dev libgles2-mesa-dev libegl1-mesa-dev \
                    libdbus-1-dev libibus-1.0-dev libudev-dev

            # --- ANDROID SETUP ---
            - name: Setup Java
              if: matrix.preset == 'android'
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"

            # --- CONFIGURE & BUILD (Desktop) ---
            - name: Setup CMake (Non-Android Only)
              if: runner.os != 'android'
              uses: jwlawson/actions-setup-cmake@v2
              with:
                  cmake-version: "3.31.x"

            - name: Configure CMake
              if: matrix.preset != 'android'
              # Use the preset name directly from the matrix
              run: cmake --preset ${{ matrix.preset }} -DCMAKE_BUILD_TYPE=Release

            - name: Build
              if: matrix.preset != 'android'
              run: cmake --build --preset ${{ matrix.build_preset }}

            # --- BUILD (Android) ---
            - name: Decode Keystore
              if: matrix.preset == 'android'
              env:
                  ANDROID_DEBUG_KEYSTORE_BASE64: ${{ secrets.ANDROID_DEBUG_KEYSTORE_BASE64 }}
              run: |
                  cd android/app
                  if [ -n "$ANDROID_DEBUG_KEYSTORE_BASE64" ]; then
                    echo "Decoding custom debug keystore..."
                    echo "$ANDROID_DEBUG_KEYSTORE_BASE64" | base64 --decode > debug.keystore
                  else
                    echo "Secret is empty (likely a fork). Using default Android debug keystore."
                  fi

            - name: Build Android APK
              if: matrix.preset == 'android'
              run: |
                  cd android
                  chmod +x gradlew
                  ./gradlew assembleDebug --no-daemon

            # --- ARTIFACT PREPARATION ---
            - name: Prepare Artifacts
              shell: bash
              run: |
                  mkdir -p staging

                  # --- WINDOWS: Collect EXE + DLLs ---
                  if [[ "${{ runner.os }}" == "Windows" ]]; then
                    find build/${{ matrix.preset }} -name "${PROJECT_NAME}.exe" -exec cp {} staging/ \;
                    find build/${{ matrix.preset }} -name "*.dll" -exec cp {} staging/ \;
                    find build/${{ matrix.preset }} -name "${PROJECT_NAME}.dat" -exec cp {} staging/ \;
                  fi

                  # --- LINUX: Collect Binary + SO files ---
                  if [[ "${{ runner.os }}" == "Linux" && "${{ matrix.preset }}" != "android" ]]; then
                    find build/${{ matrix.preset }} -maxdepth 3 -name "${PROJECT_NAME}" -type f -exec cp {} staging/ \;
                    find build/${{ matrix.preset }} -name "${PROJECT_NAME}.dat" -exec cp {} staging/ \;
                    # Find vcpkg libs if they are shared
                    find build/${{ matrix.preset }} -name "*.so*" -exec cp {} staging/ \;
                  fi

                  # --- MAC: App Bundle (Self-contained) ---
                  if [[ "${{ runner.os }}" == "macOS" ]]; then
                    APP_PATH=$(find build/${{ matrix.preset }} -name "${PROJECT_NAME}.app" -type d)
                    if [ -n "$APP_PATH" ]; then cp -r "$APP_PATH" staging/; fi
                    find build/${{ matrix.preset }} -name "${PROJECT_NAME}.dat" -exec cp {} staging/ \;
                  fi

                  # --- ANDROID ---
                  if [[ "${{ matrix.preset }}" == "android" ]]; then
                    find android -name "*.apk" -exec cp {} staging/ \;
                  fi

            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.PROJECT_NAME }}-${{ matrix.preset }}
                  path: staging/*
