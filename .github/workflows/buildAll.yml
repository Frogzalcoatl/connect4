name: Build All

on: [workflow_dispatch]

env:
    PROJECT_NAME: Connect4
    VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
    build:
        name: ${{ matrix.preset }}
        runs-on: ${{ matrix.os }}

        strategy:
            fail-fast: false
            matrix:
                include:
                    - preset: windows-msvc
                      build_preset: msvc-release
                      os: windows-2022
                    - preset: linux-gcc
                      build_preset: linux-gcc-release
                      os: ubuntu-latest
                    - preset: macos-clang
                      build_preset: macos-clang-release
                      os: macos-latest
                    - preset: android
                      os: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  submodules: true

            # Export GitHub Actions cache for vcpkg
            - name: Export GitHub Actions cache environment variables
              uses: actions/github-script@v7
              with:
                  script: |
                      core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
                      core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

            # --- SYSTEM DEPENDENCIES (Required for SDL/vcpkg to build on Linux) ---
            - name: Install Linux Dependencies
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    build-essential cmake ninja-build pkg-config \
                    libasound2-dev libpulse-dev libx11-dev libxext-dev \
                    libxrandr-dev libxcursor-dev libxfixes-dev libxi-dev \
                    libxss-dev libxtst-dev libxkbcommon-dev libdrm-dev \
                    libgbm-dev libgl1-mesa-dev libgles2-mesa-dev libegl1-mesa-dev \
                    libdbus-1-dev libibus-1.0-dev libudev-dev

            # --- ANDROID SETUP ---
            - name: Setup Java
              if: matrix.preset == 'android'
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"

            # --- CONFIGURE & BUILD (Desktop) ---
            - name: Configure CMake
              if: matrix.preset != 'android'
              # We use the preset name directly from our matrix
              run: cmake --preset ${{ matrix.preset }} -DCMAKE_BUILD_TYPE=Release

            - name: Build
              if: matrix.preset != 'android'
              run: cmake --build --preset ${{ matrix.build_preset }}

            # --- BUILD (Android) ---
            - name: Build Android APK
              if: matrix.preset == 'android'
              run: |
                  cd android
                  chmod +x gradlew
                  ./gradlew assembleDebug --no-daemon

            # --- ARTIFACT PREPARATION ---
            - name: Prepare Artifacts
              shell: bash
              run: |
                  mkdir -p staging

                  # --- WINDOWS: Collect EXE + DLLs ---
                  if [[ "${{ runner.os }}" == "Windows" ]]; then
                    # Copy the EXE
                    find build -name "${PROJECT_NAME}.exe" -exec cp {} staging/ \;
                    # Copy all DLLs found in the build folder (vcpkg puts them there)
                    find build -name "*.dll" -exec cp {} staging/ \;
                    # Copy the asset file
                    find build -name "${PROJECT_NAME}.dat" -exec cp {} staging/ \;
                  fi

                  # --- LINUX: Collect Binary + SO files ---
                  if [[ "${{ runner.os }}" == "Linux" && "${{ matrix.preset }}" != "android" ]]; then
                    cp build/${{ matrix.preset }}/${PROJECT_NAME} staging/
                    cp build/${{ matrix.preset }}/${PROJECT_NAME}.dat staging/
                    
                    # Manually grab vcpkg-built shared libraries
                    # These are usually in build/${preset}/vcpkg_installed/${triplet}/lib/
                    find build/${{ matrix.preset }}/vcpkg_installed -name "*.so*" -type f -exec cp {} staging/ \;
                  fi

                  # --- MAC: App Bundle (Self-contained) ---
                  if [[ "${{ matrix.preset }}" == "macos-clang" ]]; then
                    # Mac bundles (.app) usually contain their own libs if configured correctly
                    cp -r build/${{ matrix.preset }}/${PROJECT_NAME}.app staging/
                  fi

                  # --- ANDROID ---
                  if [[ "${{ matrix.preset }}" == "android" ]]; then
                    find android -name "*.apk" -exec cp {} staging/ \;
                  fi

            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.PROJECT_NAME }}-${{ matrix.preset }}
                  path: staging/*
